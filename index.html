import React, { useState, useEffect } from 'react';
import { Trophy, RefreshCw, CheckCircle2, XCircle, Info, ChevronRight, HelpCircle, X, Globe } from 'lucide-react';

// --- CONFIGURATION ---

const SUITS = [
  { name: 'Spades', symbol: '♠', color: 'text-gray-900', id: 's' },
  { name: 'Hearts', symbol: '♥', color: 'text-red-600', id: 'h' },
  { name: 'Diamonds', symbol: '♦', color: 'text-red-600', id: 'd' },
  { name: 'Clubs', symbol: '♣', color: 'text-gray-900', id: 'c' },
];

const VALUES = [
  { label: '2', rank: 2 },
  { label: '3', rank: 3 },
  { label: '4', rank: 4 },
  { label: '5', rank: 5 },
  { label: '6', rank: 6 },
  { label: '7', rank: 7 },
  { label: '8', rank: 8 },
  { label: '9', rank: 9 },
  { label: '10', rank: 10 },
  { label: 'J', rank: 11 },
  { label: 'Q', rank: 12 },
  { label: 'K', rank: 13 },
  { label: 'A', rank: 14 },
];

const RANK_KEYS = [
  "High Card",
  "One Pair",
  "Two Pair",
  "Three of a Kind",
  "Straight",
  "Flush",
  "Full House",
  "Four of a Kind",
  "Straight Flush",
  "Royal Flush"
];

// Example hands for the cheat sheet
// Format: [Rank, Suit Index (0=S, 1=H, 2=D, 3=C), isDimmed]
const EXAMPLE_HANDS = {
  "Royal Flush": [
    { label: '10', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: 'J', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: 'Q', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: 'K', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: 'A', symbol: '♠', color: 'text-gray-900', dim: false },
  ],
  "Straight Flush": [
    { label: '5', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '6', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '7', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '8', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '9', symbol: '♣', color: 'text-gray-900', dim: false },
  ],
  "Four of a Kind": [
    { label: 'A', symbol: '♦', color: 'text-red-600', dim: false },
    { label: 'A', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: 'A', symbol: '♥', color: 'text-red-600', dim: false },
    { label: 'A', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: '8', symbol: '♣', color: 'text-gray-900', dim: true },
  ],
  "Full House": [
    { label: 'K', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: 'K', symbol: '♥', color: 'text-red-600', dim: false },
    { label: 'K', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '10', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '10', symbol: '♠', color: 'text-gray-900', dim: false },
  ],
  "Flush": [
    { label: 'Q', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '8', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '6', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '4', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '3', symbol: '♦', color: 'text-red-600', dim: false },
  ],
  "Straight": [
    { label: '2', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '3', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: '4', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: '5', symbol: '♦', color: 'text-red-600', dim: false },
    { label: '6', symbol: '♣', color: 'text-gray-900', dim: false },
  ],
  "Three of a Kind": [
    { label: 'J', symbol: '♥', color: 'text-red-600', dim: false },
    { label: 'J', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: 'J', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: '5', symbol: '♣', color: 'text-gray-900', dim: true },
    { label: '8', symbol: '♦', color: 'text-red-600', dim: true },
  ],
  "Two Pair": [
    { label: '6', symbol: '♠', color: 'text-gray-900', dim: false },
    { label: '6', symbol: '♥', color: 'text-red-600', dim: false },
    { label: '10', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '10', symbol: '♦', color: 'text-red-600', dim: false },
    { label: 'K', symbol: '♦', color: 'text-red-600', dim: true },
  ],
  "One Pair": [
    { label: 'A', symbol: '♥', color: 'text-red-600', dim: false },
    { label: 'A', symbol: '♣', color: 'text-gray-900', dim: false },
    { label: '2', symbol: '♦', color: 'text-red-600', dim: true },
    { label: '6', symbol: '♥', color: 'text-red-600', dim: true },
    { label: '8', symbol: '♠', color: 'text-gray-900', dim: true },
  ],
  "High Card": [
    { label: 'K', symbol: '♥', color: 'text-red-600', dim: false },
    { label: 'J', symbol: '♦', color: 'text-red-600', dim: true },
    { label: '10', symbol: '♣', color: 'text-gray-900', dim: true },
    { label: '6', symbol: '♥', color: 'text-red-600', dim: true },
    { label: '3', symbol: '♦', color: 'text-red-600', dim: true },
  ]
};

const TRANSLATIONS = {
  en: {
    title: "Poker Coach",
    subtitle: "Master the ranks, one hand at a time.",
    table: "The Table (Community)",
    hand: "Your Hand (Hole Cards)",
    select: "Select the Highest Hand",
    next: "Next Hand",
    cheatSheetBtn: "Hand Rankings Cheat Sheet",
    cheatSheetTitle: "Poker Hand Rankings",
    score: "Score",
    accuracy: "Accuracy",
    correctTitle: "Excellent!",
    wrongTitle: "Not Quite",
    correctMsg: "You identified the",
    wrongMsg: "The best hand was",
    hint: "Analyze all 7 cards. The best 5-card combination determines the winner.",
    helpText: "Standard Texas Hold'em Rules • Best 5-card hand wins • Suit order does not matter.",
    ranks: {
      "High Card": "High Card",
      "One Pair": "One Pair",
      "Two Pair": "Two Pair",
      "Three of a Kind": "Three of a Kind",
      "Straight": "Straight",
      "Flush": "Flush",
      "Full House": "Full House",
      "Four of a Kind": "Four of a Kind",
      "Straight Flush": "Straight Flush",
      "Royal Flush": "Royal Flush"
    },
    descriptions: {
      "High Card": "Highest card plays.",
      "One Pair": "Two cards of the same rank.",
      "Two Pair": "Two different pairs.",
      "Three of a Kind": "Three cards of the same rank.",
      "Straight": "Five cards in sequence.",
      "Flush": "Five cards of the same suit.",
      "Full House": "Three of a kind + a pair.",
      "Four of a Kind": "Four cards of the same rank.",
      "Straight Flush": "Five cards in sequence & same suit.",
      "Royal Flush": "A, K, Q, J, 10 all of same suit."
    }
  },
  hu: {
    title: "Póker Edző",
    subtitle: "Gyakorold a kezeket, leosztásról leosztásra.",
    table: "Az Asztal (Közös Lapok)",
    hand: "A Te Lapjaid (Zárt Lapok)",
    select: "Válaszd ki a legerősebb kezet",
    next: "Következő Leosztás",
    cheatSheetBtn: "Kézerősség Puskás",
    cheatSheetTitle: "Póker Kézerősségek",
    score: "Pontszám",
    accuracy: "Pontosság",
    correctTitle: "Kiváló!",
    wrongTitle: "Nem talált",
    correctMsg: "Helyesen felismerted:",
    wrongMsg: "A legjobb kéz ez volt:",
    hint: "Vizsgáld meg mind a 7 lapot. A legjobb 5 lapos kombináció dönt.",
    helpText: "Standard Texas Hold'em Szabályok • A legjobb 5 lap nyer • A színek sorrendje nem számít.",
    ranks: {
      "High Card": "Magas Lap",
      "One Pair": "Egy Pár",
      "Two Pair": "Két Pár",
      "Three of a Kind": "Három Egyforma (Drill)",
      "Straight": "Sor",
      "Flush": "Szín (Flush)",
      "Full House": "Full House",
      "Four of a Kind": "Négy Egyforma (Póker)",
      "Straight Flush": "Színsor",
      "Royal Flush": "Royal Flush"
    },
    descriptions: {
      "High Card": "A legmagasabb lap dönt.",
      "One Pair": "Két azonos rangú lap.",
      "Two Pair": "Két különböző pár.",
      "Three of a Kind": "Három azonos rangú lap.",
      "Straight": "Öt lap sorrendben.",
      "Flush": "Öt azonos színű lap.",
      "Full House": "Három egyforma és egy pár.",
      "Four of a Kind": "Négy azonos rangú lap.",
      "Straight Flush": "Öt lap sorrendben és azonos színben.",
      "Royal Flush": "A, K, Q, J, 10 mind azonos színben."
    }
  }
};

// --- HELPER COMPONENTS ---

const Card = ({ card, hidden = false, size = "large", dim = false }) => {
  let sizeClasses = "w-14 h-20 md:w-20 md:h-28 text-lg md:text-xl rounded-lg md:rounded-xl border-2 shadow-md";
  if (size === "small") sizeClasses = "w-8 h-12 text-xs rounded border";
  if (size === "tiny") sizeClasses = "w-6 h-9 text-[0.5rem] rounded border-[0.5px] shadow-sm";

  return (
    <div className={`
      relative flex flex-col items-center justify-center bg-white 
      ${hidden ? 'bg-indigo-900 border-indigo-950' : 'border-gray-300'}
      ${dim ? 'opacity-40 bg-gray-100 grayscale-[0.8]' : ''}
      ${sizeClasses}
    `}>
      {!hidden ? (
        <>
          <span className={`font-bold leading-none ${card.color}`}>{card.label}</span>
          <span className={`leading-none ${size === "tiny" ? "text-xs" : (size === "small" ? "text-sm" : "text-2xl")} ${card.color}`}>{card.symbol}</span>
        </>
      ) : (
        <div className="w-full h-full flex items-center justify-center opacity-20">
          <div className="w-1/2 h-2/3 border border-indigo-400 rounded-sm"></div>
        </div>
      )}
    </div>
  );
};

const CheatSheet = ({ isOpen, onClose, lang }) => {
  if (!isOpen) return null;

  const ranksReversed = [...RANK_KEYS].reverse(); // Highest to lowest

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[95vh] overflow-y-auto shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl sticky top-0 z-10">
          <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <HelpCircle size={20} className="text-indigo-600" /> 
            {TRANSLATIONS[lang].cheatSheetTitle}
          </h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors">
            <X size={20} className="text-gray-500" />
          </button>
        </div>
        <div className="p-2 sm:p-4 space-y-2">
          {ranksReversed.map((rankKey, index) => (
            <div key={rankKey} className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 p-3 rounded-lg hover:bg-indigo-50 border border-transparent hover:border-indigo-100 transition-colors">
              
              {/* Rank Info */}
              <div className="flex items-center gap-3 min-w-[180px]">
                <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-bold flex items-center justify-center text-sm">
                  {10 - index}
                </div>
                <div>
                  <h3 className="font-bold text-gray-900 text-sm sm:text-base">{TRANSLATIONS[lang].ranks[rankKey]}</h3>
                  <p className="text-xs text-gray-500 leading-tight">{TRANSLATIONS[lang].descriptions[rankKey]}</p>
                </div>
              </div>

              {/* Visual Cards */}
              <div className="flex gap-1 ml-11 sm:ml-0">
                {EXAMPLE_HANDS[rankKey].map((card, idx) => (
                  <Card key={idx} card={card} size="tiny" dim={card.dim} />
                ))}
              </div>

            </div>
          ))}
        </div>
        <div className="p-4 bg-gray-50 border-t rounded-b-2xl">
          <button onClick={onClose} className="w-full py-2 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800">
            {TRANSLATIONS[lang].close || "Close"}
          </button>
        </div>
      </div>
    </div>
  );
};

// --- MAIN APP COMPONENT ---

const App = () => {
  const [deck, setDeck] = useState([]);
  const [communityCards, setCommunityCards] = useState([]);
  const [holeCards, setHoleCards] = useState([]);
  const [selectedRank, setSelectedRank] = useState(null);
  const [feedback, setFeedback] = useState(null);
  const [score, setScore] = useState({ correct: 0, total: 0 });
  const [correctRankKey, setCorrectRankKey] = useState("");
  const [lang, setLang] = useState('en');
  const [showCheatSheet, setShowCheatSheet] = useState(false);

  const t = TRANSLATIONS[lang];

  useEffect(() => {
    generateNewHand();
  }, []);

  const generateNewHand = () => {
    const newDeck = [];
    SUITS.forEach(suit => {
      VALUES.forEach(value => {
        newDeck.push({ ...value, ...suit });
      });
    });

    // Fisher-Yates Shuffle
    for (let i = newDeck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
    }

    const comm = newDeck.slice(0, 5);
    const hole = newDeck.slice(5, 7);
    
    setCommunityCards(comm);
    setHoleCards(hole);
    setDeck(newDeck.slice(7));
    setSelectedRank(null);
    setFeedback(null);
    
    const bestHand = evaluateBestHand([...comm, ...hole]);
    setCorrectRankKey(bestHand);
  };

  const evaluateBestHand = (sevenCards) => {
    const counts = {};
    const suitCounts = {};
    const ranks = sevenCards.map(c => c.rank).sort((a, b) => b - a);
    
    sevenCards.forEach(c => {
      counts[c.rank] = (counts[c.rank] || 0) + 1;
      suitCounts[c.name] = (suitCounts[c.name] || 0) + 1;
    });

    const countValues = Object.values(counts);
    const hasFlush = Object.values(suitCounts).some(count => count >= 5);
    
    // Check Straight
    const uniqueRanks = [...new Set(ranks)].sort((a, b) => b - a);
    let hasStraight = false;
    for (let i = 0; i <= uniqueRanks.length - 5; i++) {
      if (uniqueRanks[i] - uniqueRanks[i+4] === 4) hasStraight = true;
    }
    // Low Ace Straight (A, 2, 3, 4, 5) -> 14, 5, 4, 3, 2
    if (uniqueRanks.includes(14) && uniqueRanks.includes(2) && uniqueRanks.includes(3) && uniqueRanks.includes(4) && uniqueRanks.includes(5)) {
      hasStraight = true;
    }

    // Straight Flush / Royal Flush Check
    if (hasFlush) {
      const flushSuit = Object.keys(suitCounts).find(s => suitCounts[s] >= 5);
      const flushCards = sevenCards.filter(c => c.name === flushSuit).map(c => c.rank).sort((a, b) => b - a);
      let realStraightFlush = false;
      
      // Check normal straight flush
      for (let i = 0; i <= flushCards.length - 5; i++) {
        if (flushCards[i] - flushCards[i+4] === 4) realStraightFlush = true;
      }
      // Check low ace straight flush
      if (flushCards.includes(14) && flushCards.includes(2) && flushCards.includes(3) && flushCards.includes(4) && flushCards.includes(5)) {
        realStraightFlush = true;
      }

      if (realStraightFlush) {
        if (flushCards.includes(14) && flushCards.includes(13) && flushCards.includes(12) && flushCards.includes(11) && flushCards.includes(10)) return "Royal Flush";
        return "Straight Flush";
      }
    }

    if (countValues.includes(4)) return "Four of a Kind";
    
    const hasThree = countValues.includes(3);
    const pairCount = countValues.filter(v => v === 2).length;
    const tripleCount = countValues.filter(v => v === 3).length;

    if ((tripleCount >= 2) || (tripleCount === 1 && pairCount >= 1)) return "Full House";
    if (hasFlush) return "Flush";
    if (hasStraight) return "Straight";
    if (hasThree) return "Three of a Kind";
    if (pairCount >= 2) return "Two Pair";
    if (pairCount === 1) return "One Pair";
    
    return "High Card";
  };

  const handleGuess = (rankKey) => {
    if (feedback) return;
    
    setSelectedRank(rankKey);
    const isCorrect = rankKey === correctRankKey;
    setFeedback(isCorrect ? 'correct' : 'wrong');
    setScore(prev => ({
      correct: prev.correct + (isCorrect ? 1 : 0),
      total: prev.total + 1
    }));
  };

  const toggleLanguage = () => {
    setLang(prev => prev === 'en' ? 'hu' : 'en');
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">
      <CheatSheet isOpen={showCheatSheet} onClose={() => setShowCheatSheet(false)} lang={lang} />
      
      <div className="max-w-4xl mx-auto">
        {/* Header & Controls */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <div>
            <h1 className="text-3xl font-extrabold flex items-center gap-2 text-slate-900">
              <Trophy className="text-amber-500 fill-amber-500" /> {t.title}
            </h1>
            <p className="text-slate-500 text-sm">{t.subtitle}</p>
          </div>
          
          <div className="flex items-center gap-3 w-full md:w-auto">
             <button 
              onClick={toggleLanguage}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm transition-colors text-sm font-bold text-slate-600"
            >
              <Globe size={16} />
              {lang === 'en' ? 'English' : 'Magyar'}
            </button>
            
            <button 
              onClick={() => setShowCheatSheet(true)}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 shadow-sm transition-colors text-sm font-bold text-slate-600"
            >
              <HelpCircle size={16} />
              <span className="hidden sm:inline">{t.cheatSheetBtn}</span>
            </button>
          </div>
        </div>

        {/* Stats Bar */}
        <div className="grid grid-cols-2 gap-4 mb-6">
           <div className="bg-white px-4 py-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
             <span className="text-xs uppercase tracking-wider text-slate-400 font-bold">{t.score}</span>
             <span className="text-xl font-black text-indigo-600">{score.correct} / {score.total}</span>
           </div>
           <div className="bg-white px-4 py-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
             <span className="text-xs uppercase tracking-wider text-slate-400 font-bold">{t.accuracy}</span>
             <span className="text-xl font-black text-emerald-600">
               {score.total === 0 ? '0' : Math.round((score.correct / score.total) * 100)}%
             </span>
           </div>
        </div>

        {/* Game Board */}
        <div className="bg-emerald-900 rounded-3xl p-4 md:p-8 shadow-2xl mb-6 relative overflow-hidden border-8 border-emerald-950">
          <div className="absolute inset-0 bg-black/20 pointer-events-none"></div>
          
          {/* Community Cards */}
          <div className="relative mb-8 text-center">
            <h3 className="text-emerald-200/80 text-xs font-bold uppercase tracking-[0.2em] mb-3">{t.table}</h3>
            <div className="flex flex-wrap justify-center gap-2 md:gap-4">
              {communityCards.map((card, i) => <Card key={i} card={card} />)}
            </div>
          </div>

          {/* Player Hand */}
          <div className="relative text-center">
            <h3 className="text-emerald-200/80 text-xs font-bold uppercase tracking-[0.2em] mb-3">{t.hand}</h3>
            <div className="flex justify-center gap-3 md:gap-4">
              {holeCards.map((card, i) => <Card key={i} card={card} />)}
            </div>
          </div>
        </div>

        {/* Controls */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Options Grid */}
          <div className="lg:col-span-2 bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
            <h3 className="text-md font-bold text-slate-800 mb-4 flex items-center gap-2">
              <ChevronRight className="text-indigo-500" size={20} /> {t.select}
            </h3>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
              {RANK_KEYS.map((rankKey) => (
                <button
                  key={rankKey}
                  onClick={() => handleGuess(rankKey)}
                  disabled={feedback !== null}
                  className={`
                    p-3 rounded-lg text-sm font-semibold transition-all border
                    ${selectedRank === rankKey 
                      ? (feedback === 'correct' ? 'bg-emerald-100 border-emerald-500 text-emerald-800' : 'bg-rose-100 border-rose-500 text-rose-800')
                      : (feedback && rankKey === correctRankKey ? 'bg-emerald-100 border-emerald-500 text-emerald-800 animate-pulse ring-2 ring-emerald-400' : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:bg-indigo-50')
                    }
                    ${feedback && rankKey !== correctRankKey && rankKey !== selectedRank ? 'opacity-40 grayscale' : ''}
                  `}
                >
                  {t.ranks[rankKey]}
                </button>
              ))}
            </div>
          </div>

          {/* Feedback & Action */}
          <div className="flex flex-col">
            {feedback ? (
              <div className={`h-full rounded-3xl p-6 shadow-sm border flex flex-col items-center justify-center text-center animate-in fade-in zoom-in duration-300 ${
                feedback === 'correct' ? 'bg-emerald-50 border-emerald-200' : 'bg-rose-50 border-rose-200'
              }`}>
                {feedback === 'correct' ? (
                  <>
                    <CheckCircle2 className="w-10 h-10 text-emerald-500 mb-2" />
                    <h4 className="text-lg font-bold text-emerald-800">{t.correctTitle}</h4>
                    <p className="text-emerald-700 text-xs mb-4">{t.correctMsg} <span className="font-bold">{t.ranks[correctRankKey]}</span>.</p>
                  </>
                ) : (
                  <>
                    <XCircle className="w-10 h-10 text-rose-500 mb-2" />
                    <h4 className="text-lg font-bold text-rose-800">{t.wrongTitle}</h4>
                    <p className="text-rose-700 text-xs mb-4">{t.wrongMsg} <span className="font-bold underline">{t.ranks[correctRankKey]}</span>.</p>
                  </>
                )}
                <button 
                  onClick={generateNewHand}
                  className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-800 transition-colors shadow-lg"
                >
                  {t.next} <RefreshCw size={16} />
                </button>
              </div>
            ) : (
              <div className="h-full bg-slate-50 border border-slate-200 rounded-3xl p-6 flex flex-col items-center justify-center text-center">
                <Info className="w-8 h-8 text-indigo-400 mb-2" />
                <p className="text-indigo-900/70 text-sm font-medium leading-relaxed">{t.hint}</p>
              </div>
            )}
          </div>
        </div>

        <div className="mt-8 text-center text-slate-400 text-xs font-medium">
          <p>{t.helpText}</p>
        </div>
      </div>
    </div>
  );
};

export default App;
